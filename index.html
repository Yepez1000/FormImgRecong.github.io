<!DOCTYPE html>
<html lang="en">


<link href="styles.css" rel="stylesheet" type="text/css">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Capture</title>
       
</head>

<body>
    <div class="form-container">
        <form id="info-form">
            <label for="operator-name">Operator Name:</label>
            <select id="operator-name" name="operator-name">
                <option value="Oscar">Oscar</option>
                <option value="Julio">Julio</option>
                <option value="Edgar">Edgar</option>
            </select>

            <label for="customer">Customer:</label>
            <input type="text" id="customer" name="customer">

            <label for="As">As:</label>
            <input type="text" id="As" name="As">

            <label for="Tracking">Tracking:</label>
            <input type="text" id="Tracking" name="Tracking">

            <label for="Carrier">Carrier:</label>
            <input type="text" id="Carrier" name="Carrier">

            <button type="button">Get Data</button>

            <label for="weight">Weight:</label>
            <input type="text" id="weight" name="weight">

            <label for="length">Length:</label>
            <input type="text" id="length" name="length">

            <label for="width">Width:</label>
            <input type="text" id="width" name="width">

            <label for="height">Height:</label>
            <input type="text" id="height" name="height">

            <button type="button" onclick="printLabel()">Print Label</button>
            <button type="button" onclick="printPackageIDLabel()">Print package ID label</button>
            <button type="submit">Submit</button>
        </form>
    </div>

    <div id="gallery">
        <h1>Saved Images</h1>
        <!-- Captured images will be added here -->
    </div>

    <div id="camera-container">
        <video id="cameraFeed" autoplay></video>
        <div id="controls">
            <button id="captureImage">Capture Image</button>
            <button id="startCapture">Start Capture</button>
            <button id="stopCapture" disabled>Stop Capture</button>
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="capturedImage" />
    </div>

    <script>
        const startCaptureButton = document.getElementById('startCapture');
        const stopCaptureButton = document.getElementById('stopCapture');
        const captureImageButton = document.getElementById('captureImage');
        const cameraFeed = document.getElementById('cameraFeed');
        const canvas = document.getElementById('canvas');
        const context = canvas.getContext('2d');
        const gallery = document.getElementById('gallery');
        const capturedImage = document.getElementById('capturedImage');
        

        let stream;
        let captureInterval;
        let images = [];

        // Function to convert dataURL to Blob
        function dataURLToBlob(dataURL) {
            const [header, data] = dataURL.split(',');
            const mime = header.split(':')[1].split(';')[0];
            const byteString = atob(data);
            const u8arr = new Uint8Array(byteString.length);

            for (let i = 0; i < byteString.length; i++) {
                u8arr[i] = byteString.charCodeAt(i);
            }

            return new Blob([u8arr], { type: mime });
        }

        // Start the camera
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true });
                cameraFeed.srcObject = stream;
            } catch (err) {
                console.error('Error accessing webcam:', err);
            }
        }
        function captureImage() {
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');



            const img = document.createElement('img');
            img.src = imageData;
            img.title = `Captured on ${new Date().toLocaleString()}`;
            img.addEventListener('click', () => {
                capturedImage.src = imageData;
            });

            gallery.appendChild(img);

            // Save image data for future upload
            images.push(imageData);
            // addImageToList(imageData);


            // Add image to gallery
            const imgElement = document.createElement('img');
            imgElement.src = imageData;
            // imageList.appendChild(imageData);
        }

        // Function to capture and upload image
        function captureAndUploadImage() {
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            context.drawImage(cameraFeed, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg');

            const img = document.createElement('img');
            img.src = imageData;
            img.title = `Captured on ${new Date().toLocaleString()}`;
            img.addEventListener('click', () => {
                capturedImage.src = imageData;
            });


            // Save image data for future upload
            images.push(imageData);

            // Convert the image data to Blob
            const blob = dataURLToBlob(imageData);
            const formData = new FormData();
            formData.append('file', blob, 'captured_image.jpg');

            // Upload captured image to the server
            fetch('http://192.168.0.119:8080/upload', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Upload successful:', data);

                    // Get references to the input fields
                    const customerField = document.getElementById('customer');
                    const AsField = document.getElementById('As');
                    const trackingField = document.getElementById('Tracking');
                    const carrierField = document.getElementById('Carrier');

                    // Update the customer and As fields with the response data only if they are empty
                    if (!customerField.value) {
                        customerField.value = data.name;
                    }
                    if (!AsField.value) {
                        AsField.value = data.As;
                    }
                    if (!trackingField.value) {
                        trackingField.value = data.tracking_number;
                    }
                    if (!carrierField.value) {
                        carrierField.value = data.carrier;
                    }
                })
                .catch(error => {
                    console.error('Error uploading image:', error);
                });
        }

        // Start capturing images every second
        function startCapturing() {
            captureInterval = setInterval(captureAndUploadImage, 1000); // Capture and upload every second
        }

        // Stop capturing images
        function stopCapturing() {
            clearInterval(captureInterval);
        }

        // Start the camera when the page loads
        window.onload = startCamera;

        // Add event listeners for buttons
        startCaptureButton.addEventListener('click', () => {
            startCaptureButton.disabled = true;
            stopCaptureButton.disabled = false;
            startCapturing();
        });

        stopCaptureButton.addEventListener('click', () => {
            stopCaptureButton.disabled = true;
            startCaptureButton.disabled = false;
            stopCapturing();
        });

        captureImageButton.addEventListener('click', function (event) {
                captureImage(event);
            });
    </script>
</body>

</html>